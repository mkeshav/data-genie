services:
  dev:
    build:
      context: .
      target: dev
    volumes:
      - .:/app:cached

  # dockerignore will be bypassed if you mount volume like dev
  test:
    build:
      context: .
      target: dev
    command: >
      bash -c "tox -e py39"
    environment:
      - PYPI_API_TOKEN
      - CODACY_PROJECT_TOKEN
      - CIRCLE_SHA1

  smoke_test:
    image: python:3.9
    volumes:
      - ./smoke_test.py:/app/smoke_test.py
    working_dir: /app
    command: >
      bash -c "python3 -m pip install data-genie;/app/smoke_test.py"
